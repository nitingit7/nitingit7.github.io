<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam</title>
    
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="js/config.js"></script>
</head>
<body>

    <div id="view-exam" class="view active" style="width:100%; height:100%; display:none; flex-direction:column;">
        <header>
            <div id="exam-title">Mock Test</div>

            <div class="header-right-group">
        
                <div class="timer-container" id="timer-box-el">
                    <span class="timer-icon">⏳</span>
                    <div class="timer" id="timer-display">00:00</div>
                </div>

                <div class="header-actions">
                    <button class="btn-header btn-pause" id="btn-pause" title="Pause">⏸</button>
                    <button class="btn-header btn-exit" id="btn-exit" title="Exit Test">✖</button>
                    <button class="btn-header btn-header-outline" id="btn-toggle-sidebar">☰</button>
                </div>
            </div>
        </header>
        <div class="exam-body">
            <main class="q-area">
                <div class="q-content">
                    <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:15px;">
                        <div>
                            <strong style="color:var(--blue);" id="q-number">Q1</strong>
                            <span id="btn-report" class="report-link">Report Error</span>
                        </div>
                        
                        <span class="marks-badge">Marks: +1 / -0.25</span>
                    </div>
                    
                    <div id="review-badges" class="review-badges-container" style="display:none;">
                        <div id="review-status-badge" class="review-badge"></div>
                        <div id="review-time-badge" class="review-badge"></div>
                    </div>

                    <div id="practice-toggle-box" class="switch-container" style="display:none;">
                        <label class="switch">
                            <input type="checkbox" id="btn-practice-mode">
                            <span class="slider"></span>
                        </label>
                        <span class="practice-label">Re-attempt</span>
                    </div>

                    <div id="q-extra-info" class="q-extra-info"></div>

                    <div id="q-text" style="margin-bottom:20px;">Loading...</div>
                    <div id="options-box"></div>
                    <div id="solution-box" class="solution-box">
                        <strong>Solution:</strong> <div id="sol-text"></div>
                    </div>
                </div>
                <div class="q-footer" id="exam-footer">
                    <div>
                        <button class="btn btn-red" id="btn-clear">Clear</button>
                        <button class="btn btn-purple" id="btn-review">Review</button>
                    </div>
                    <button class="btn btn-green" id="btn-save">Save & Next</button>
                </div>
                <div class="q-footer" id="review-footer" style="display:none;">
                    <button class="btn btn-outline" id="btn-prev">Prev</button>
                    <button class="btn btn-blue" id="btn-next">Next</button>
                    <button class="btn btn-red" id="btn-exit-review">Exit</button>
                </div>
            </main>
            <aside id="sidebar">
                <div style="padding:10px; font-weight:bold; border-bottom:1px solid var(--border-color);">
                    Palette <span style="float:right; cursor:pointer;" id="btn-close-sidebar">✖</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div style="margin-top:auto; padding:15px;">
                    <button class="btn btn-green" style="width:100%;" id="btn-submit">SUBMIT TEST</button>
                </div>
            </aside>
        </div>
    </div>

    <div id="pause-overlay">
        <h1>Test Paused</h1>
        <p style="margin-bottom:30px;">Timer stopped.</p>
        <button class="btn btn-green" style="padding:15px 30px;" id="btn-resume">RESUME</button>
        <button class="btn btn-red" style="margin-top:20px; background:transparent; border:1px solid #aaa;" id="btn-quit">Quit Test</button>
    </div>

    <div id="view-result" class="view-result">
        <div class="score-card">
            <h2>Test Result</h2>
            <div id="feedback-badge" class="feedback-badge">Processing...</div>
            <div style="font-size:3.5rem; font-weight:bold; color:var(--blue);" id="final-score">0</div>
            <p style="margin-bottom:10px;">Total Marks</p>
            <div id="time-taken-box" class="time-badge">Time: 0s</div>
            
            <div class="stat-grid">
                <div class="stat-item" style="border-bottom: 3px solid var(--green);"><div class="stat-val" id="res-correct" style="color:var(--green)">0</div><div class="stat-label">Correct</div></div>
                <div class="stat-item" style="border-bottom: 3px solid var(--red);"><div class="stat-val" id="res-wrong" style="color:var(--red)">0</div><div class="stat-label">Wrong</div></div>
                <div class="stat-item" style="border-bottom: 3px solid #666;"><div class="stat-val" id="res-unatt">0</div><div class="stat-label">Unatt.</div></div>
            </div>
            
            <button class="btn btn-orange" style="width:100%; margin-bottom:10px;" id="btn-reattempt">Re-attempt Test</button>
            <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" id="btn-view-sols">Review Solutions</button>
            
            <button class="btn btn-outline" style="width:100%;" onclick="history.go(-2)">Back to Home</button>
        </div>
    </div>

    <div id="img-modal" class="img-modal" onclick="closeImgModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="img-modal-content">
        <div id="caption"></div>
    </div>

    <script>
    window.app = {
        fullData: null,         // Stores the whole JSON
        currentSectionIdx: 0,   // Tracks which section we are in (0, 1, 2)
        sectionResponses: [],   // Stores answers for ALL sections
        
        // Current Section Data (Temporary helpers)
        data: null,             // Points to the CURRENT section object
        responses: {},          // Answers for CURRENT section
        currQ: 0,
        
        timerInterval: null,
        totalTimeSeconds: 0, 
        startTime: 0, 
        accumulatedPauseTime: 0, 
        pauseStartTimestamp: 0,
        isPaused: false,
        isReview: false,
        currentFileUrl: "",

        init: function() {
            var params = new URLSearchParams(window.location.search);
            this.currentFileUrl = params.get('file');
            var showResult = params.get('showResult');

            if(!this.currentFileUrl) { alert("No file specified"); location.href = "index.html"; return; }
            
            // ... (Your existing History/Popstate code here) ...
            
            this.bind('btn-save', () => this.saveNext());
            this.bind('btn-submit', () => this.submitSection(false)); // Changed behavior
            // ... (Bind other buttons as usual) ...

            if(showResult === "true") {
                this.showStoredResult(this.currentFileUrl);
            } else {
                this.fetchTest(this.currentFileUrl);
            }
        },

        bind: function(id, func) {
            var el = document.getElementById(id);
            if(el) el.addEventListener('click', func);
        },

        fetchTest: function(url) {
            var self = this;
            fetch(url + "?v=" + Date.now())
                .then(res => res.json())
                .then(json => { 
                    self.startFullExam(json); 
                })
                .catch(err => alert("Error: " + err));
        },

        startFullExam: function(jsonObj) {
            this.fullData = jsonObj;
            this.sectionResponses = []; 
            this.currentSectionIdx = 0;
            
            // Check if it's a Sectional Test (Old Format) or Full Mock (New Format)
            if(jsonObj.sections && Array.isArray(jsonObj.sections)) {
                // It's a FULL MOCK
                this.loadSection(0);
            } else {
                // It's an OLD SINGLE TEST (Convert it to a "Section 1" structure)
                this.fullData = {
                    title: jsonObj.title,
                    isFullMock: false,
                    sections: [{
                        name: "General",
                        timeLimit: jsonObj.timeLimit || 20,
                        questions: jsonObj.questions
                    }]
                };
                this.loadSection(0);
            }
        },

        loadSection: function(index) {
            // 1. Setup Data for this Section
            var sec = this.fullData.sections[index];
            this.data = sec; // The app now thinks this "Section" is the whole test
            this.currQ = 0;
            this.responses = {}; 
            
            // Initialize empty responses for this section
            for(var i=0; i<sec.questions.length; i++) {
                this.responses[i] = { sel: null, status: 'not-visited', timeSpent: 0 };
            }
            
            // 2. Setup Timer
            this.totalTimeSeconds = (sec.timeLimit || 20) * 60;
            this.startTime = Date.now();
            this.accumulatedPauseTime = 0;
            this.startTimer();

            // 3. UI Updates
            document.getElementById('exam-title').innerText = this.fullData.title + " - " + sec.name;
            
            // Show a "Section Popup" (Optional but recommended)
            alert("Starting Section: " + sec.name + "\nTime: " + sec.timeLimit + " mins");

            this.switchView('exam');
            this.loadQ();
        },

        submitSection: function(force) {
            if(!force && !confirm("Submit this SECTION? You cannot return to it.")) return;
            
            // 1. Save results for this section
            this.sectionResponses[this.currentSectionIdx] = this.responses;
            clearInterval(this.timerInterval);

            // 2. Check if there is a Next Section
            if (this.currentSectionIdx < this.fullData.sections.length - 1) {
                this.currentSectionIdx++;
                this.loadSection(this.currentSectionIdx);
            } else {
                // 3. No more sections -> Finish Test
                this.finishTest();
            }
        },

        finishTest: function() {
            var totalScore = 0, totalCorr = 0, totalWrong = 0, totalUnatt = 0, totalMax = 0;
            var grandTotalTime = 0;

            // Loop through all sections to calculate final score
            for(var i=0; i<this.fullData.sections.length; i++) {
                var sec = this.fullData.sections[i];
                var resp = this.sectionResponses[i]; // Answers for this section
                
                if(!resp) continue; // Safety check

                sec.questions.forEach((q, qIdx) => {
                    var r = resp[qIdx];
                    totalMax++;
                    if(r.sel !== null) {
                        if(r.sel === q.correctIndex) { totalScore += 1; totalCorr++; }
                        else { totalScore -= 0.25; totalWrong++; }
                    } else {
                        totalUnatt++;
                    }
                });
            }

            // Save Result
            if(this.currentFileUrl) {
                var resultObj = {
                    score: totalScore, correct: totalCorr, wrong: totalWrong, 
                    unatt: totalUnatt, totalMarks: totalMax,
                    fullData: this.fullData,
                    sectionResponses: this.sectionResponses
                };
                localStorage.setItem(this.currentFileUrl, JSON.stringify(resultObj));
            }

            this.renderResultScreen(totalScore, totalCorr, totalWrong, totalUnatt, totalMax, 0);
        },

        // ... [KEEP YOUR EXISTING helper functions: loadQ, saveNext, etc.] ...
        
        // MODIFIED: Update Timer to submit SECTION, not Test
        updateTimerDisplay: function() {
            var disp = document.getElementById('timer-display');
            if(!disp) return;
            var now = Date.now();
            var elapsedSeconds = Math.floor((now - this.startTime - this.accumulatedPauseTime) / 1000);
            var remaining = this.totalTimeSeconds - elapsedSeconds;
            
            if(remaining <= 0) { 
                remaining = 0; 
                clearInterval(this.timerInterval); 
                this.submitSection(true); // Auto-submit section when time is up
            }
            
            // ... (Rest of formatting logic remains same) ...
            var m = Math.floor(remaining / 60).toString().padStart(2,'0');
            var s = (remaining % 60).toString().padStart(2,'0');
            disp.innerText = m + ":" + s;
        },

        // ... [KEEP YOUR EXISTING renderResultScreen, etc.] ...
    };
    window.onload = function() { window.app.init(); };
</script>
</body>
</html>
