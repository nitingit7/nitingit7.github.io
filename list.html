<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Test</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/config.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
            <div class="back-btn" onclick="location.href='index.html'" style="margin-bottom: 0;">‚Üê Back</div>
            
            <div style="position: relative;">
                <button id="btn-filter-toggle" class="btn-filter" onclick="toggleFilterMenu()">
                    <span>üîç Filter</span>
                </button>
                <div id="filter-dropdown" class="filter-dropdown">
                    <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-size: 0.9rem;">
                        Filter by Name
                        <span style="float: right; cursor: pointer;" onclick="toggleFilterMenu()">‚úñ</span>
                    </div>
                    <div id="filter-options-list" class="filter-list"></div>

                    <button class="btn-clear-filter" onclick="clearFilter()">
                        üóëÔ∏è Clear Filter
                    </button>
                </div>
            </div>
        </div>

        <h2 id="list-title">Select Test</h2>
        
        <div id="test-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        
        <div id="no-result-msg" style="display:none; color: var(--text-secondary); margin-top: 20px;">No matching tests found.</div>
    </div>

    <script>
    // --- CONFIGURATION: ADD YOUR FILTER KEYWORDS HERE ---
    // Make sure these match the words in your JSON names EXACTLY.
    var FILTER_KEYWORDS = [
        "RRB Clerk",
        "RRB PO",
        "IBPS Clerk",
        "IBPS PO",
        "SBI Clerk",
        "SBI PO",
        "Mains",
        "Speed Math",
        "Full Mock",
        "Sectional Mock"
    ];

    // Theme Logic
    var savedTheme = localStorage.getItem('site-theme');
    if(savedTheme === 'dark') { document.body.classList.add('dark-mode'); }

    // Variables
    var currentFilter = null;

    window.onload = function() {
        var params = new URLSearchParams(window.location.search);
        var subject = params.get('subject');

        // In list.html
        if(subject) localStorage.setItem('last_subject_viewed', subject);

        // Save the current subject to memory so we can return here later
        if(subject) localStorage.setItem('last_subject_viewed', subject)
        
        if(!subject || !GITHUB_FILES[subject]) {
            alert("Invalid Subject");
            location.href = 'index.html';
            return;
        }

        document.getElementById('list-title').innerText = subject.toUpperCase().replace('_', ' ');
        var list = document.getElementById('test-container');
        var files = GITHUB_FILES[subject];

        // 1. Render the Tests
        files.forEach(function(f) {
            var div = document.createElement('div');
            div.className = 'test-item';
            // We verify the filter using this attribute later
            div.setAttribute('data-name', f.name.toLowerCase()); 
            
            div.innerHTML = "<span>" + f.name + "</span>";
            
            var saved = localStorage.getItem(f.file);
            var btn = document.createElement('button');
            
            if (saved) {
                btn.className = 'btn btn-blue'; 
                btn.innerText = "Results"; 
                btn.onclick = function() { location.href = "exam.html?showResult=true&file=" + encodeURIComponent(f.file); };
            } else {
                btn.className = 'btn btn-green'; 
                btn.innerText = "Start";
                btn.onclick = function() { location.href = "instructions.html?file=" + encodeURIComponent(f.file); };
            }
            div.appendChild(btn);
            list.appendChild(div);
        });

        // 2. Render the Filter Options
        renderFilterOptions();
    };

    // --- FILTER FUNCTIONS ---

    function toggleFilterMenu() {
        var menu = document.getElementById('filter-dropdown');
        menu.classList.toggle('show');
    }

    function renderFilterOptions() {
        var container = document.getElementById('filter-options-list');
        container.innerHTML = '';

        FILTER_KEYWORDS.forEach(function(word) {
            var btn = document.createElement('div');
            btn.className = 'filter-option';
            btn.innerText = word;
            btn.onclick = function() { applyFilter(word, btn); };
            container.appendChild(btn);
        });
    }

    function applyFilter(word, btnElement) {
        currentFilter = word.toLowerCase();
        
        // Update UI Styles
        var allOpts = document.querySelectorAll('.filter-option');
        allOpts.forEach(el => el.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');

        document.getElementById('btn-filter-toggle').classList.add('active');
        document.getElementById('btn-filter-toggle').innerHTML = '<span>Checking: ' + word + '</span>';

        // Filter Logic
        var items = document.querySelectorAll('.test-item');
        var visibleCount = 0;

        items.forEach(function(item) {
            var testName = item.getAttribute('data-name');
            // EXACT WORD CHECK
            if (testName.includes(currentFilter)) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        // Toggle "No Results" message
        var msg = document.getElementById('no-result-msg');
        if(visibleCount === 0) msg.style.display = 'block';
        else msg.style.display = 'none';

        // Close menu
        toggleFilterMenu();
    }

    function clearFilter() {
        currentFilter = null;
        
        var items = document.querySelectorAll('.test-item');
        items.forEach(item => item.style.display = 'flex');
        
        var allOpts = document.querySelectorAll('.filter-option');
        allOpts.forEach(el => el.classList.remove('selected'));

        document.getElementById('btn-filter-toggle').classList.remove('active');
        document.getElementById('btn-filter-toggle').innerHTML = '<span>üîç Filter</span>';
        document.getElementById('no-result-msg').style.display = 'none';
        
        toggleFilterMenu();
    }

    // Close menu if clicking outside
    window.onclick = function(event) {
        if (!event.target.matches('.btn-filter') && !event.target.closest('.filter-dropdown') && !event.target.closest('.btn-filter')) {
            var dropdowns = document.getElementsByClassName("filter-dropdown");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
    
    window.onpageshow = function(event) {
        if (event.persisted) { window.location.reload(); }
    };
</script>
</body>
</html>
