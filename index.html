<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banking Mock Test</title>
    
    <!-- KaTeX (Math) with Error Handling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --blue: #007bff; --green: #28a745; --red: #dc3545; --dark: #343a40; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        .view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        /* DEBUG BOX (Visible only if error occurs) */
        #debug-console { display: none; background: #333; color: #ff4444; padding: 10px; font-size: 12px; max-height: 100px; overflow: auto; border-bottom: 2px solid red; }

        /* HOME */
        #view-home { padding: 20px; overflow-y: auto; }
        .subject-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
        .subject-card:active { background: #eee; }

        /* EXAM */
        header { height: 60px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .exam-body { display: flex; flex: 1; overflow: hidden; }
        .q-area { flex: 1; display: flex; flex-direction: column; background: white; padding: 20px; overflow-y: auto; }
        .q-footer { padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }
        
        .opt-row { padding: 12px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; }
        .opt-row.selected { background: #e3f2fd; border-color: var(--blue); }
        .opt-row.correct { background: #d4edda; } 
        .opt-row.wrong { background: #f8d7da; }

        /* SIDEBAR */
        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: 280px; background: white; border-left: 1px solid #ccc; transform: translateX(100%); transition: 0.3s; z-index: 10; display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(0); }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; overflow-y: auto; }
        .pal-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .btn-green { background: var(--green); } .btn-red { background: var(--red); } .btn-blue { background: var(--blue); }
    </style>
</head>
<body>

    <!-- DEBUGGER -->
    <div id="debug-console"></div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <h2 style="color: #333; margin-bottom: 30px;">Banking Mock Tests</h2>
        
        <div class="subject-card" onclick="showList('quant')">
            <div><strong>Quantitative Aptitude</strong></div> <span>➜</span>
        </div>
        <div class="subject-card" onclick="showList('reasoning')">
            <div><strong>Reasoning Ability</strong></div> <span>➜</span>
        </div>
        <div class="subject-card" onclick="showList('english')">
            <div><strong>English Language</strong></div> <span>➜</span>
        </div>
    </div>

    <!-- LIST -->
    <div id="view-list" class="view">
        <div style="padding:10px; cursor:pointer; color:blue;" onclick="switchView('view-home')">← Back</div>
        <h2 id="list-title" style="padding:0 20px;">Select Test</h2>
        <div id="test-container" style="padding:20px;"></div>
    </div>

    <!-- EXAM -->
    <div id="view-exam" class="view">
        <header>
            <div id="exam-title">Mock Test</div>
            <div style="display:flex; gap:10px;">
                <div id="timer-display">00:00</div>
                <button onclick="toggleSidebar()" style="background:none; border:1px solid white; color:white;">☰</button>
            </div>
        </header>
        <div class="exam-body">
            <main class="q-area">
                <div id="q-number" style="color:blue; font-weight:bold;">Q1</div>
                <div id="q-text" style="margin: 20px 0;">Loading...</div>
                <div id="options-box"></div>
                <div id="solution-box" style="display:none; margin-top:20px; background:#fff3cd; padding:10px;"></div>
            </main>
            <aside id="sidebar">
                <div class="palette-grid" id="palette-grid"></div>
                <div style="margin-top:auto; padding:15px;">
                    <button class="btn btn-green" style="width:100%;" onclick="submitTest(false)">SUBMIT</button>
                </div>
            </aside>
        </div>
        <div class="q-footer">
            <button class="btn btn-red" onclick="clearResponse()">Clear</button>
            <button class="btn btn-blue" onclick="saveNext()">Save & Next</button>
        </div>
    </div>

    <!-- RESULT -->
    <div id="view-result" class="view">
        <div style="text-align:center; padding:40px;">
            <h2>Result</h2>
            <h1 id="final-score" style="font-size:3rem; color:blue;">0</h1>
            <button class="btn btn-blue" onclick="startReviewMode()">Review</button>
            <br><br>
            <button class="btn btn-red" onclick="location.reload()">Home</button>
        </div>
    </div>

    <script>
    // --- ERROR LOGGER ---
    window.onerror = function(msg, url, line) {
        var d = document.getElementById('debug-console');
        d.style.display = 'block';
        d.innerHTML += "Error: " + msg + " (Line " + line + ")<br>";
        return false;
    };

    // 1. CONFIGURATION
    var FILES = {
        'quant': [ 
            { name: "Quant Mock 1", file: "tests/quant/mock1.json" } 
        ],
        'reasoning': [ 
            { name: "Reasoning Mock 1", file: "tests/reasoning/mock1.json" } 
        ],
        'english': [ 
            { name: "English Mock 1", file: "tests/english/mock1.json" } 
        ]
    };

    // 2. STATE
    var data = null;
    var responses = {};
    var currQ = 0;
    var timer = null;
    var timeLeft = 0;
    var isReview = false;

    // 3. FUNCTIONS
    function switchView(id) {
        document.querySelectorAll('.view').forEach(function(el) { el.classList.remove('active'); });
        document.getElementById(id).classList.add('active');
    }

    function showList(subj) {
        var list = document.getElementById('test-container');
        list.innerHTML = "";
        document.getElementById('list-title').innerText = subj.toUpperCase();
        
        var items = FILES[subj] || [];
        if(items.length === 0) list.innerHTML = "No tests found.";
        
        items.forEach(function(item) {
            var div = document.createElement('div');
            div.style.padding = "15px"; div.style.border = "1px solid #ddd"; div.style.marginBottom = "10px";
            div.innerHTML = "<span>" + item.name + "</span> <button style='float:right;' class='btn btn-green' onclick='fetchTest(\"" + item.file + "\")'>Start</button>";
            list.appendChild(div);
        });
        switchView('view-list');
    }

    function fetchTest(url) {
        // Anti-cache param to force reload new file
        var cleanUrl = url + "?t=" + new Date().getTime();
        fetch(cleanUrl)
            .then(function(r) { 
                if(!r.ok) throw new Error("File not found (" + r.status + ")"); 
                return r.json(); 
            })
            .then(function(json) { startExam(json); })
            .catch(function(e) { alert("Error loading test:\n" + e.message); });
    }

    function startExam(json) {
        data = json;
        responses = {};
        currQ = 0;
        isReview = false;
        
        if(!data.questions) { alert("JSON format invalid: missing 'questions'"); return; }

        for(var i=0; i<data.questions.length; i++) responses[i] = { sel: null };
        timeLeft = (data.timeLimit || 20) * 60;
        
        if(timer) clearInterval(timer);
        timer = setInterval(function() {
            if(timeLeft <= 0) { clearInterval(timer); submitTest(true); return; }
            timeLeft--;
            var m = Math.floor(timeLeft/60); var s = timeLeft%60;
            document.getElementById('timer-display').innerText = m + ":" + (s<10?"0"+s:s);
        }, 1000);

        document.getElementById('exam-title').innerText = data.title || "Test";
        switchView('view-exam');
        loadQ();
    }

    function loadQ() {
        var q = data.questions[currQ];
        var r = responses[currQ];
        
        document.getElementById('q-number').innerText = "Q" + (currQ + 1);
        document.getElementById('q-text').innerText = q.text;
        
        var box = document.getElementById('options-box');
        box.innerHTML = "";
        
        q.options.forEach(function(opt, idx) {
            var row = document.createElement('div');
            row.className = 'opt-row';
            if(isReview) {
                if(idx === q.correctIndex) row.style.background = "#d4edda";
                if(r.sel === idx && idx !== q.correctIndex) row.style.background = "#f8d7da";
            } else {
                if(r.sel === idx) row.style.background = "#e3f2fd";
                row.onclick = function() { r.sel = idx; loadQ(); };
            }
            row.innerHTML = opt;
            box.appendChild(row);
        });

        var sol = document.getElementById('solution-box');
        if(isReview) {
            sol.style.display = "block";
            sol.innerText = "Solution: " + (q.solution || "None");
        } else {
            sol.style.display = "none";
        }

        renderPalette();
        if(window.renderMathInElement) renderMathInElement(document.body);
    }

    function renderPalette() {
        var p = document.getElementById('palette-grid');
        p.innerHTML = "";
        for(var i=0; i<data.questions.length; i++) {
            (function(idx){
                var btn = document.createElement('div');
                btn.className = 'pal-btn';
                btn.innerText = idx + 1;
                
                if(responses[idx].sel !== null) btn.style.background = "#28a745";
                if(idx === currQ) btn.style.border = "2px solid black";
                
                // Added toggleSidebar here to close menu on click
                btn.onclick = function() { currQ = idx; loadQ(); toggleSidebar(); };
                p.appendChild(btn);
            })(i);
        }
    }

    // FIXED: Added missing function
    function toggleSidebar() {
        var s = document.getElementById('sidebar');
        if(s.style.transform === "translateX(0px)") s.style.transform = "translateX(100%)";
        else s.style.transform = "translateX(0px)";
    }

    function saveNext() {
        if(currQ < data.questions.length - 1) { currQ++; loadQ(); }
        else { if(confirm("Submit?")) submitTest(false); }
    }

    function clearResponse() {
        responses[currQ].sel = null;
        loadQ();
    }

    function submitTest(force) {
        if(!force && !confirm("Submit Test?")) return;
        clearInterval(timer);
        
        var score = 0;
        data.questions.forEach(function(q, i) {
            if(responses[i].sel === q.correctIndex) score += 1;
            else if(responses[i].sel !== null) score -= 0.25;
        });

        document.getElementById('final-score').innerText = score;
        switchView('view-result');
    }

    function startReviewMode() {
        isReview = true;
        currQ = 0;
        switchView('view-exam');
        loadQ();
    }
    </script>
</body>
</html>
