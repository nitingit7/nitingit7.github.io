<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banking Mock Test Pro</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* CSS RESET */
        :root { --blue: #007bff; --green: #28a745; --red: #dc3545; --yellow: #ffc107; --purple: #6f42c1; --dark: #343a40; --light: #f8f9fa; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }

        .view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        /* HOME */
        #view-home { align-items: center; padding: 20px; overflow-y: auto; }
        .subject-card { background: white; width: 100%; max-width: 500px; padding: 25px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid transparent; transition: 0.2s; }
        .subject-card:active { transform: scale(0.98); background: #eee; }
        .icon { font-size: 24px; margin-right: 15px; }

        /* LIST */
        #view-list { align-items: center; padding: 20px; }
        .test-item { background: white; width: 100%; max-width: 500px; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }

        /* EXAM HEADER */
        header { height: 60px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; flex-shrink: 0; }
        #exam-title { font-weight: bold; font-size: 1.1rem; max-width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* TIMER */
        .timer-box { display: flex; align-items: center; gap: 8px; }
        .timer { font-family: monospace; font-size: 1.1rem; font-weight: bold; background: #222; color: #fff; padding: 6px 10px; border-radius: 4px; border: 1px solid #555; }
        .timer.warning { background: #c00; border-color: #f00; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        .btn-header { padding: 6px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-pause { background: var(--yellow); color: #222; }
        .btn-exit { background: var(--red); color: white; }

        /* EXAM BODY */
        .exam-body { display: flex; flex: 1; overflow: hidden; position: relative; }
        .q-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        .q-content { flex: 1; padding: 20px; overflow-y: auto; font-size: 1.1rem; line-height: 1.6; }
        .q-footer { padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }

        /* DI / GRAPH STYLES */
        .q-direction { 
            font-style: normal; 
            color: #000;           /* Pure Black */
            margin-bottom: 15px; 
            font-weight: bold;     /* Make it bold like real exams */
            font-size: 1rem; 
        }
        .q-image { max-width: 100%; height: auto; display: block; margin: 10px auto 20px auto; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* TABLE STYLING */
        .q-extra-info table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
        .q-extra-info th, .q-extra-info td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .q-extra-info th { background-color: #f8f9fa; font-weight: bold; }

        .opt-row { display: flex; padding: 12px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; cursor: pointer; align-items: center; }
        .opt-row.selected { background: #e3f2fd; border-color: var(--blue); border-width: 2px; }
        .opt-row.correct { background: #d4edda !important; border-color: var(--green) !important; }
        .opt-row.wrong { background: #f8d7da !important; border-color: var(--red) !important; }
        
        .solution-box { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; margin-top: 20px; border-radius: 5px; display: none; }
        
        /* REVIEW BADGES */
        .review-badges-container { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .review-badge { display: inline-block; background: #e2e6ea; color: #495057; font-size: 0.85rem; padding: 4px 12px; border-radius: 15px; font-weight: bold; border: 1px solid #ccc; }

        /* REPORT BTN */
        .report-link { font-size: 0.8rem; color: #dc3545; text-decoration: underline; cursor: pointer; margin-left: 15px; }

        /* SIDEBAR */
        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: 280px; background: white; border-left: 1px solid #ccc; transform: translateX(100%); transition: 0.3s; z-index: 10; display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(0); box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; overflow-y: auto; }
        .pal-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 12px; }
        .p-ans { background: var(--green); color: white; border: none; }
        .p-not { background: var(--red); color: white; border: none; }
        .p-rev { background: var(--purple); color: white; border: none; }

        /* PAUSE OVERLAY */
        #pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }

        /* RESULT */
        #view-result { justify-content: center; align-items: center; background: white; }
        .score-card { text-align: center; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 10px; width: 90%; max-width: 400px; overflow-y:auto; max-height:95vh; }
        .feedback-badge { display:inline-block; padding:10px 20px; border-radius:30px; color:white; font-weight:bold; margin-bottom:20px; font-size:1rem; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-item { padding: 10px; border-radius: 5px; background: #f8f9fa; border: 1px solid #eee; }
        .stat-val { font-weight: bold; font-size: 1.2rem; }
        .stat-label { font-size: 0.8rem; color: #666; }
        
        .time-badge { margin: 10px 0; padding: 8px 15px; background: #e9ecef; border-radius: 20px; font-weight: bold; color: #495057; display: inline-block; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); }
        .btn-purple { background: var(--purple); }
        .btn-orange { background: #fd7e14; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }
        
        .back-btn {
            display: block; background-color: var(--blue); color: white;
            padding: 10px; font-size: 1rem; font-weight: bold; text-align: center;
            border-radius: 8px; margin-bottom: 20px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .back-btn:active { transform: scale(0.98); opacity: 0.9; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>

    <div id="view-home" class="view active">
        <h2 style="color: var(--dark); margin-bottom: 30px;">Banking Mock Tests(beta)</h2>
        
        <div class="subject-card" id="card-quant">
            <div style="display:flex; align-items:center;">
                <span class="icon">üìä</span> <div><strong>Quantitative Aptitude</strong></div>
            </div> <span>‚ûú</span>
        </div>
        <div class="subject-card" id="card-reasoning">
            <div style="display:flex; align-items:center;">
                <span class="icon">üß©</span> <div><strong>Reasoning Ability</strong></div>
            </div> <span>‚ûú</span>
        </div>
        <div class="subject-card" id="card-english">
            <div style="display:flex; align-items:center;">
                <span class="icon">üìñ</span> <div><strong>English Language</strong></div>
            </div> <span>‚ûú</span>
        </div>
        <div style="margin-top: 40px; text-align: center; color: #888; font-size: 0.85rem;">
            üí° Tip: <strong>Refresh the page often</strong> to see new tests!
        </div>
    </div>

    <div id="view-list" class="view">
        <div class="back-btn" id="btn-back-home">‚Üê Back</div>
        <h2 id="list-title">Select Test</h2>
        <div id="test-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
    </div>

    <div id="view-exam" class="view">
        <header>
            <div id="exam-title">Mock Test</div>
            <div class="timer-box">
                <div class="timer" id="timer-display">00:00</div>
                <button class="btn-header btn-pause" id="btn-pause" title="Pause">‚è∏</button>
                <button class="btn-header btn-exit" id="btn-exit" title="Exit Test">‚úñ</button>
                <button class="btn-outline" style="background:white; padding: 5px 10px;" id="btn-toggle-sidebar">‚ò∞</button>
            </div>
        </header>
        <div class="exam-body">
            <main class="q-area">
                <div class="q-content">
                    <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:15px;">
                        <div>
                            <strong style="color:var(--blue);" id="q-number">Q1</strong>
                            <span id="btn-report" class="report-link">Report Error</span>
                        </div>
                        <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;">Marks: +1 / -0.25</span>
                    </div>
                    
                    <div id="review-badges" class="review-badges-container" style="display:none;">
                        <div id="review-status-badge" class="review-badge"></div>
                        <div id="review-time-badge" class="review-badge"></div>
                    </div>

                    <div id="q-extra-info" class="q-extra-info"></div>

                    <div id="q-text" style="margin-bottom:20px;">Loading...</div>
                    <div id="options-box"></div>
                    <div id="solution-box" class="solution-box">
                        <strong>Solution:</strong> <div id="sol-text"></div>
                    </div>
                </div>
                <div class="q-footer" id="exam-footer">
                    <div>
                        <button class="btn btn-red" id="btn-clear">Clear</button>
                        <button class="btn btn-purple" id="btn-review">Review</button>
                    </div>
                    <button class="btn btn-green" id="btn-save">Save & Next</button>
                </div>
                <div class="q-footer" id="review-footer" style="display:none;">
                    <button class="btn btn-outline" id="btn-prev">Prev</button>
                    <button class="btn btn-blue" id="btn-next">Next</button>
                    <button class="btn btn-red" id="btn-exit-review">Exit</button>
                </div>
            </main>
            <aside id="sidebar">
                <div style="padding:10px; font-weight:bold; border-bottom:1px solid #eee;">
                    Palette <span style="float:right; cursor:pointer;" id="btn-close-sidebar">‚úñ</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div style="margin-top:auto; padding:15px;">
                    <button class="btn btn-green" style="width:100%;" id="btn-submit">SUBMIT TEST</button>
                </div>
            </aside>
        </div>
    </div>

    <div id="pause-overlay">
        <h1>Test Paused</h1>
        <p style="margin-bottom:30px;">Timer stopped.</p>
        <button class="btn btn-green" style="padding:15px 30px;" id="btn-resume">RESUME</button>
        <button class="btn btn-red" style="margin-top:20px; background:transparent; border:1px solid #555;" id="btn-quit">Quit Test</button>
    </div>

    <div id="view-result" class="view">
        <div class="score-card">
            <h2 style="color:#333;">Test Result</h2>
            
            <div id="feedback-badge" class="feedback-badge">Processing...</div>
            
            <div style="font-size:3.5rem; font-weight:bold; color:var(--blue);" id="final-score">0</div>
            <p style="color:#666; margin-bottom:10px;">Total Marks</p>
            
            <div id="time-taken-box" class="time-badge">Time: 0s</div>
            
            <div class="stat-grid">
                <div class="stat-item" style="border-bottom: 3px solid var(--green);">
                    <div class="stat-val" id="res-correct" style="color:var(--green)">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-item" style="border-bottom: 3px solid var(--red);">
                    <div class="stat-val" id="res-wrong" style="color:var(--red)">0</div>
                    <div class="stat-label">Wrong</div>
                </div>
                <div class="stat-item" style="border-bottom: 3px solid #666;">
                    <div class="stat-val" id="res-unatt">0</div>
                    <div class="stat-label">Unatt.</div>
                </div>
            </div>
            
            <button class="btn btn-orange" style="width:100%; margin-bottom:10px;" id="btn-reattempt">Re-attempt Test</button>
            <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" id="btn-view-sols">Review Solutions</button>
            <button class="btn btn-outline" style="width:100%;" onclick="location.reload()">Back to Home</button>
        </div>
    </div>

    <script>
    // --- GITHUB FILE CONFIGURATION ---
    var BASE_URL = "https://nitingit7.github.io/Mock-Test/";
    
    var GITHUB_FILES = {
        'quant': [
            { name: "Testing", file: BASE_URL + "tests/quant/mock1.json" },
            { name: "RRB Clerk Speed Math 1", file: BASE_URL + "tests/quant/mock2.json" },
            { name: "RRB Clerk Quant: [Easy]", file: BASE_URL + "tests/quant/mock3.json" },
            { name: "RRB Clerk Speed Math 2", file: BASE_URL + "tests/quant/SM2.json" },
            { name: "RRB Clerk Prelims: Quant[Moderate]", file: BASE_URL + "tests/quant/hardqa1.json" },
            { name: "RRB Clerk Prelims: Quant [Easy-Moderate]", file: BASE_URL + "tests/quant/quanteasymod.json" },
            { name: "RRB Clerk Prelims: Quant [Easy-Moderate]", file: BASE_URL + "tests/quant/easytomode2.json" },
            { name: "RRB Clerk Prelims: Quant [moderate]", file: BASE_URL + "tests/quant/quant5.json" }
        ],
        'reasoning': [
            { name: "RRB Clerk Reasoning: Puzzle & Seating", file: BASE_URL + "tests/reasoning/mock1.json" },
            { name: "RRB Clerk Reasoning: Sectional 1", file: BASE_URL + "tests/reasoning/reas2.json" },
            { name: "RRB Clerk Reasoning: Puzzle & Seating Maratho", file: BASE_URL + "tests/reasoning/puzzlemarathon.json" }
        ],
        'english': [
            { name: "COMING SOON....", file: BASE_URL + "tests/english/mock1.json" }
        ]
    };

    // --- PASTE YOUR GOOGLE FORM PRE-FILLED LINK HERE ---
    // Example: "https://docs.google.com/forms/d/e/.../viewform?usp=pp_url&entry.123456=TEST_NAME_HERE&entry.789012=Q_NUM_HERE"
    var GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfcBe23FbEQkCmH2QEWLUvV2Ei0CFezkOv54BXYG40GheCCLw/viewform?usp=pp_url&entry.57428168=TEST_NAME_HERE&entry.1889905698=Q_NUM_HERE"; 
    
    // --- APP LOGIC ---
    window.app = {
        data: null, responses: {}, currQ: 0, 
        timerInterval: null, 
        totalTimeSeconds: 0, startTime: 0, accumulatedPauseTime: 0, pauseStartTimestamp: 0,
        questionStartTime: 0,
        isReview: false, isPaused: false, currentFileUrl: "",

        init: function() {
            this.safeBind('card-quant', () => this.showList('quant'));
            this.safeBind('card-reasoning', () => this.showList('reasoning'));
            this.safeBind('card-english', () => this.showList('english'));
            this.safeBind('btn-back-home', () => this.switchView('view-home'));
            
            this.safeBind('btn-toggle-sidebar', () => this.toggleSidebar());
            this.safeBind('btn-close-sidebar', () => this.toggleSidebar());
            this.safeBind('btn-pause', () => this.togglePause());
            this.safeBind('btn-exit', () => this.exitTest());
            
            this.safeBind('btn-save', () => this.saveNext());
            this.safeBind('btn-clear', () => this.clearResponse());
            this.safeBind('btn-review', () => this.markReview());
            this.safeBind('btn-submit', () => this.submitTest(false));
            
            this.safeBind('btn-prev', () => this.prevQ());
            this.safeBind('btn-next', () => this.nextQ());
            this.safeBind('btn-exit-review', () => this.exitReview());
            
            this.safeBind('btn-resume', () => this.togglePause());
            this.safeBind('btn-quit', () => this.exitTest());
            
            this.safeBind('btn-view-sols', () => this.startReviewMode());
            this.safeBind('btn-reattempt', () => this.reattemptTest());
            
            // BIND REPORT BUTTON
            this.safeBind('btn-report', () => this.reportIssue());

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && this.timerInterval && !this.isPaused) {
                    this.updateTimerDisplay();
                }
            });
        },

        safeBind: function(id, func) {
            var el = document.getElementById(id);
            if(el) el.addEventListener('click', func);
        },

        setText: function(id, text) {
            var el = document.getElementById(id);
            if (el) { el.innerText = text; }
        },

        switchView: function(id) {
            var views = document.querySelectorAll('.view');
            for(var i=0; i<views.length; i++) { views[i].classList.remove('active'); }
            document.getElementById(id).classList.add('active');
        },

        showList: function(subj) {
            var list = document.getElementById('test-container');
            list.innerHTML = '';
            this.setText('list-title', subj.toUpperCase());
            var files = GITHUB_FILES[subj];
            if(!files || files.length === 0) { list.innerHTML = "<p>No files configured.</p>"; }
            var self = this;
            for (var j = 0; j < files.length; j++) {
                (function(idx) {
                    var f = files[idx];
                    var div = document.createElement('div');
                    div.className = 'test-item';
                    div.innerHTML = "<span>" + f.name + "</span>";
                    var saved = localStorage.getItem(f.file);
                    var btn = document.createElement('button');
                    if (saved) {
                        btn.className = 'btn btn-blue'; btn.innerText = "Show Result";
                        btn.onclick = function() { self.showStoredResult(f.file); };
                    } else {
                        btn.className = 'btn btn-green'; btn.innerText = "Start";
                        btn.onclick = function() { self.fetchTest(f.file); };
                    }
                    div.appendChild(btn); list.appendChild(div);
                })(j);
            }
            this.switchView('view-list');
        },

        fetchTest: function(url) {
            var self = this;
            var cleanUrl = url + "?v=" + new Date().getTime();
            fetch(cleanUrl)
                .then(function(res) { if(!res.ok) throw new Error("Status " + res.status); return res.json(); })
                .then(function(json) { self.currentFileUrl = url; self.startExam(json); })
                .catch(function(err) { alert("Error loading test: " + err.message); });
        },

        startExam: function(jsonObj) {
            this.data = jsonObj; this.responses = {}; this.currQ = 0;
            this.isReview = false; this.isPaused = false;
            
            if(!this.data.questions) { alert("Invalid JSON"); return; }

            for(var i=0; i<this.data.questions.length; i++) {
                this.responses[i] = { sel: null, status: 'not-visited', timeSpent: 0 };
            }
            
            this.totalTimeSeconds = (this.data.timeLimit || 20) * 60;
            this.startTime = Date.now(); this.accumulatedPauseTime = 0;
            this.startTimer();

            this.questionStartTime = Date.now();
            
            this.setText('exam-title', this.data.title || "Mock Test");
            
            document.getElementById('timer-display').style.display = '';
            document.getElementById('btn-pause').style.display = '';
            document.getElementById('btn-exit').style.display = '';
            document.getElementById('btn-submit').style.display = 'block';

            document.getElementById('exam-footer').style.display = 'flex';
            document.getElementById('review-footer').style.display = 'none';
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('review-badges').style.display = 'none';
            
            this.switchView('view-exam');
            this.loadQ();
        },

        startTimer: function() {
            if(this.timerInterval) clearInterval(this.timerInterval);
            var self = this;
            this.updateTimerDisplay();
            this.timerInterval = setInterval(function() {
                if(self.isPaused) return;
                self.updateTimerDisplay();
            }, 500); 
        },

        updateTimerDisplay: function() {
            var disp = document.getElementById('timer-display');
            if(!disp) return;
            var now = Date.now();
            var elapsedSeconds = Math.floor((now - this.startTime - this.accumulatedPauseTime) / 1000);
            var remaining = this.totalTimeSeconds - elapsedSeconds;
            if(remaining <= 0) { remaining = 0; clearInterval(this.timerInterval); this.submitTest(true); }
            if(remaining < 60) disp.classList.add('warning'); else disp.classList.remove('warning');
            var m = Math.floor(remaining / 60).toString().padStart(2,'0');
            var s = (remaining % 60).toString().padStart(2,'0');
            disp.innerText = m + ":" + s;
        },

        captureQuestionTime: function() {
            if (this.isReview || this.isPaused) return; 
            var now = Date.now();
            var diffSeconds = (now - this.questionStartTime) / 1000;
            if (this.responses[this.currQ]) { this.responses[this.currQ].timeSpent += diffSeconds; }
            this.questionStartTime = now;
        },

        togglePause: function() {
            this.isPaused = !this.isPaused;
            var el = document.getElementById('pause-overlay');
            if (this.isPaused) {
                this.captureQuestionTime(); 
                this.pauseStartTimestamp = Date.now(); el.style.display = 'flex';
            } else {
                var pauseDuration = Date.now() - this.pauseStartTimestamp;
                this.accumulatedPauseTime += pauseDuration;
                this.questionStartTime = Date.now();
                el.style.display = 'none'; this.updateTimerDisplay(); 
            }
        },

        exitTest: function() {
            if(confirm("Exit Test? Progress will be lost.")) {
                if(this.timerInterval) clearInterval(this.timerInterval);
                this.switchView('view-home');
                document.getElementById('pause-overlay').style.display = 'none';
            }
        },

        // --- REPORT ISSUE FUNCTION ---
        reportIssue: function() {
            if(!GOOGLE_FORM_URL) {
                alert("Please configure the GOOGLE_FORM_URL variable in the code first.");
                return;
            }
            var testName = this.data.title || "Unknown Test";
            var qNum = "Q" + (this.currQ + 1);
            
            // Replace placeholders in URL
            var finalUrl = GOOGLE_FORM_URL
                .replace("TEST_NAME_HERE", encodeURIComponent(testName))
                .replace("Q_NUM_HERE", encodeURIComponent(qNum));
                
            window.open(finalUrl, '_blank');
        },

        loadQ: function() {
            var q = this.data.questions[this.currQ];
            var r = this.responses[this.currQ];
            
            if(!this.isReview && r.status === 'not-visited') r.status = 'not-answered';
            
            this.setText('q-number', "Q" + (this.currQ + 1));
            this.setText('q-text', q.text);

            var extra = document.getElementById('q-extra-info');
            extra.innerHTML = ''; 

            if (q.direction) {
                var d = document.createElement('div');
                d.className = 'q-direction';
                d.innerHTML = "<b>Direction:</b> " + q.direction;
                extra.appendChild(d);
            }
            function addImg(url) {
                if(url.includes('github.com') && url.includes('/blob/')) {
                    url = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                }
                var img = document.createElement('img');
                img.src = url; img.className = 'q-image'; img.alt = "Graph/Chart";
                extra.appendChild(img);
            }
            if (q.image) { addImg(q.image); }
            if (q.images && Array.isArray(q.images)) { q.images.forEach(function(url) { addImg(url); }); }
            if (q.infoHtml) {
                var div = document.createElement('div');
                div.innerHTML = q.infoHtml;
                div.style.marginBottom = "20px"; div.style.overflowX = "auto";
                extra.appendChild(div);
            }
            
            var badgeContainer = document.getElementById('review-badges');
            var timeBadge = document.getElementById('review-time-badge');
            var statusBadge = document.getElementById('review-status-badge');

            if (this.isReview) {
                badgeContainer.style.display = 'flex';
                if (r.sel === null) {
                    statusBadge.innerText = "Skipped"; statusBadge.style.background = "#e2e6ea"; statusBadge.style.color = "#495057"; statusBadge.style.border = "1px solid #ced4da";
                } else if (r.sel === q.correctIndex) {
                    statusBadge.innerText = "Correct"; statusBadge.style.background = "#d4edda"; statusBadge.style.color = "#155724"; statusBadge.style.border = "1px solid #c3e6cb";
                } else {
                    statusBadge.innerText = "Wrong"; statusBadge.style.background = "#f8d7da"; statusBadge.style.color = "#721c24"; statusBadge.style.border = "1px solid #f5c6cb";
                }
                var spent = r.timeSpent || 0;
                var tm = Math.floor(spent / 60); var ts = Math.floor(spent % 60);
                var timeStr = (tm > 0 ? tm + "m " : "") + ts + "s";
                timeBadge.innerText = "Time: " + timeStr;
                if (spent > 120) { timeBadge.style.background = "#fff3cd"; timeBadge.style.color = "#856404"; } 
                else { timeBadge.style.background = "#e2e6ea"; timeBadge.style.color = "#495057"; } 
            } else {
                badgeContainer.style.display = 'none';
            }

            var box = document.getElementById('options-box');
            if(box) {
                box.innerHTML = '';
                var self = this;
                q.options.forEach(function(opt, i) {
                    var row = document.createElement('div');
                    row.className = 'opt-row';
                    if(self.isReview) {
                        row.style.pointerEvents = 'none';
                        if(i === q.correctIndex) row.classList.add('correct');
                        if(r.sel === i && i !== q.correctIndex) row.classList.add('wrong');
                    } else {
                        if(r.sel === i) row.classList.add('selected');
                        row.onclick = function() { r.sel = i; self.loadQ(); };
                    }
                    row.innerHTML = "<b>" + ['A','B','C','D','E'][i] + "</b> &nbsp; " + opt;
                    box.appendChild(row);
                });
            }

            var solBox = document.getElementById('solution-box');
            if(solBox) {
                if(this.isReview) {
                    solBox.style.display = 'block';
                    this.setText('sol-text', q.solution || "No solution.");
                } else {
                    solBox.style.display = 'none';
                }
            }

            this.renderPalette();
            try { if(window.renderMathInElement) { renderMathInElement(document.body); } } catch(e){}
        },

        saveNext: function() {
            this.captureQuestionTime(); 
            var r = this.responses[this.currQ];
            if(r.sel !== null) r.status = 'ans'; else r.status = 'not-answered';
            if(this.currQ < this.data.questions.length - 1) { this.currQ++; this.loadQ(); }
            else { if(confirm("End of questions. Submit Test?")) { this.submitTest(false); } }
        },

        markReview: function() {
            this.captureQuestionTime();
            var r = this.responses[this.currQ];
            if(r.sel !== null) r.status = 'ans-rev'; else r.status = 'rev';
            if(this.currQ < this.data.questions.length - 1) { this.currQ++; this.loadQ(); }
        },

        clearResponse: function() {
            this.responses[this.currQ].sel = null;
            this.responses[this.currQ].status = 'not-answered';
            this.loadQ();
        },

        prevQ: function() { if(this.currQ > 0) { this.captureQuestionTime(); this.currQ--; this.loadQ(); } },
        nextQ: function() { if(this.currQ < this.data.questions.length - 1) { this.captureQuestionTime(); this.currQ++; this.loadQ(); } },

        renderPalette: function() {
            var grid = document.getElementById('palette-grid');
            if(!grid) return; grid.innerHTML = ''; var self = this;
            for(var i=0; i<this.data.questions.length; i++) {
                (function(idx){
                    var btn = document.createElement('div');
                    btn.className = 'pal-btn'; btn.innerText = idx + 1;
                    var s = self.responses[idx].status;
                    if(self.isReview) {
                        var r = self.responses[idx];
                        if(r.sel === self.data.questions[idx].correctIndex) btn.style.background = '#28a745';
                        else if(r.sel !== null) btn.style.background = '#dc3545';
                        else btn.style.background = '#ccc';
                        btn.style.color = 'white';
                    } else {
                        if(s === 'ans') { btn.style.background = "#28a745"; btn.style.color="white"; }
                        else if(s === 'ans-rev') { btn.style.background = "#6f42c1"; btn.style.color="white"; }
                        else if(s === 'rev') { btn.style.background = "#6f42c1"; btn.style.color="white"; }
                        else if(s === 'not-answered') { btn.style.background = "#dc3545"; btn.style.color="white"; }
                        if(s === 'ans-rev') { btn.style.border = "2px solid #28a745"; }
                    }
                    if(idx === self.currQ) btn.style.border = '2px solid black';
                    btn.onclick = function() { if(!self.isReview) self.captureQuestionTime(); self.currQ = idx; self.loadQ(); self.toggleSidebar(); };
                    grid.appendChild(btn);
                })(i);
            }
        },

        toggleSidebar: function() { 
            var sb = document.getElementById('sidebar');
            if(sb) { if(sb.classList.contains('open')) sb.classList.remove('open'); else sb.classList.add('open'); }
        },
        
        submitTest: function(force) {
            if(!force && !confirm("Submit Test?")) return;
            this.captureQuestionTime();
            if(this.timerInterval) clearInterval(this.timerInterval);
            
            var now = Date.now();
            var elapsedSeconds = Math.floor((now - this.startTime - this.accumulatedPauseTime) / 1000);
            if(elapsedSeconds > this.totalTimeSeconds) elapsedSeconds = this.totalTimeSeconds;
            
            var score = 0, corr = 0, wrong = 0, unatt = 0; var totalMarks = 0;
            var self = this;
            this.data.questions.forEach(function(q, i) {
                var r = self.responses[i]; totalMarks += 1;
                if(r.sel !== null) {
                    if(r.sel === q.correctIndex) { score += 1; corr++; } else { score -= 0.25; wrong++; }
                } else unatt++;
            });

            if(self.currentFileUrl) {
                var resultObj = {
                    score: score, correct: corr, wrong: wrong, unatt: unatt, totalMarks: totalMarks,
                    responses: self.responses, data: self.data, timeSpent: elapsedSeconds
                };
                localStorage.setItem(self.currentFileUrl, JSON.stringify(resultObj));
            }
            this.renderResultScreen(score, corr, wrong, unatt, totalMarks, elapsedSeconds);
        },

        showStoredResult: function(url) {
            var savedJSON = localStorage.getItem(url); if(!savedJSON) return;
            this.currentFileUrl = url; var res = JSON.parse(savedJSON);
            this.data = res.data; this.responses = res.responses;
            var timeSpent = res.timeSpent || 0; 
            this.renderResultScreen(res.score, res.correct, res.wrong, res.unatt, res.totalMarks, timeSpent);
        },

        renderResultScreen: function(score, corr, wrong, unatt, total, timeSpent) {
            this.setText('final-score', score.toFixed(2));
            this.setText('res-correct', corr); this.setText('res-wrong', wrong); this.setText('res-unatt', unatt);
            var m = Math.floor(timeSpent / 60); var s = timeSpent % 60;
            var timeString = (m > 0 ? m + "m " : "") + s + "s";
            this.setText('time-taken-box', 'Time Taken: ' + timeString);
            var pct = (score / total) * 100; var msg = "", color = "#666";
            if (pct < 40) { msg = "Try Again"; color = "#dc3545"; }
            else if (pct < 70) { msg = "Room for Improvement"; color = "#fd7e14"; }
            else if (pct < 80) { msg = "Good"; color = "#ffc107"; } 
            else if (pct < 90) { msg = "Very Good"; color = "#28a745"; }
            else if (pct < 100) { msg = "Excellent"; color = "#20c997"; }
            else { msg = "Perfect"; color = "#007bff"; }
            var badge = document.getElementById('feedback-badge');
            badge.innerText = msg; badge.style.background = color;
            this.switchView('view-result');
        },

        reattemptTest: function() {
            if(confirm("Clear previous result and re-attempt?")) {
                localStorage.removeItem(this.currentFileUrl); this.fetchTest(this.currentFileUrl);
            }
        },

        startReviewMode: function() {
            this.isReview = true; this.currQ = 0;
            document.getElementById('timer-display').style.display = 'none';
            document.getElementById('btn-pause').style.display = 'none';
            document.getElementById('btn-exit').style.display = 'none';
            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('exam-footer').style.display = 'none';
            document.getElementById('review-footer').style.display = 'flex';
            this.switchView('view-exam');
            this.loadQ();
        },

        exitReview: function() { this.switchView('view-result'); }
    };

    window.onload = function() { window.app.init(); };
    </script>
</body>
</html>
